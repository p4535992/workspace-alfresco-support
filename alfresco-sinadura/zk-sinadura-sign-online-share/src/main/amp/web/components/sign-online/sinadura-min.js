var sinadura=sinadura||[];sinadura.DefaultServerURL="http://localhost:8080/sinaduraCloud";function Sinadura(h,t){var e="sinadura";var j=2000;var k=600000;var a="rest/v1";var m="h";var q="s";var d="transactions";var o={tsAdd:"add",tsRemove:"remove",setConfig:"config/add",getDocuments:"documents/get",getStatus:"status/get",addDocument:"document/add"};var u={ERR_JS_SIGN_TIMEOUT:"ERR_JS_SIGN_TIMEOUT",ERR_WS_INTERNAL:"ERR_WS_INTERNAL"};var n={TS_STARTED:"TS_STARTED",CONFIG_READY:"CONFIG_READY",SIGN_STARTED:"SIGN_STARTED",SIGN_EXECUTED:"SIGN_EXECUTED",TS_ERROR:"TS_ERROR"};var l=h;var v=0;var r=l+"/"+a;var s=r+"/"+d;var f=function(y,x,w){console.log(y+" - "+x+" - "+w)};var g=t;var c={};var p=jQuery.Deferred();var i=jQuery.Deferred();var b=[];if(!h){h=sinadura.DefaultServerURL}if(!window.console){console={log:function(){}}}startTransaction=function(w){jQuery.post(s+"/"+o.tsAdd,function(x){console.log("start transaction ok, uuid: "+x);g=x;w.resolve()}).fail(function(y,z,x){handleRestError(y,z,x)});return w.promise()};setConfig=function(w){config={properties:c};configString=JSON.stringify(config);console.log("set config: "+configString);jQuery.when.apply(this,b).done(function(){jQuery.post(s+"/"+g+"/"+o.setConfig,{config:configString},function(x){console.log("set config ok: "+x);w.resolve()}).fail(function(y,z,x){handleRestError(y,z,x)})});return w.promise()};addDocumentRest=function(w,A,z,y,x){console.log("add document, id: "+A+" - name: "+y);jQuery.post(s+"/"+g+"/"+o.addDocument,{id:A,type:z,name:y,url:x},function(B){console.log("add document ok, id: "+B);w.resolve()}).fail(function(C,D,B){handleRestError(C,D,B)});return w.promise()};handleRestError=function(x,y,w){console.log("handleRestError xhr: "+JSON.stringify(x));console.log("handleRestError status: "+x.status);console.log("handleRestError textStatus: "+y);console.log("handleRestError errorThrown: "+w);if(x.status===500){f(x.responseJSON.code,x.responseJSON.message,x.status)}else{f(u.ERR_WS_INTERNAL,w,x.status)}};openApplication=function(){var x;if(r.indexOf("https")>-1){x=r.replace("https",e)+"/"+q+"/"+g}else{x=r.replace("http",e)+"/"+m+"/"+g}console.log("open application: "+x);var w=window.open(x,"_parent");w.blur();v=new Date()};pollSignStatus=function(w){setTimeout(function(){jQuery.ajax({type:"GET",url:s+"/"+g+"/"+o.getStatus,data:{},success:function(y){if(y==n.SIGN_EXECUTED){jQuery.get(s+"/"+g+"/"+o.getDocuments,function(B,z,A){console.log("get documents ok, code: "+A.status);if(A.status===200){console.log(B);w(B);i.resolve()}}).fail(function(A,B,z){handleRestError(A,B,z)})}else{if(y==n.TS_ERROR){jQuery.get(s+"/"+g+"/error/get",function(B,z,A){console.log("get error code ok, status: "+A.status);if(A.status===200){f(B.code,B.message,null)}}).fail(function(A,B,z){handleRestError(A,B,z)})}else{var x=new Date()-v;if(x<k){pollSignStatus(w)}else{console.log("pooling timeout");f(u.ERR_JS_SIGN_TIMEOUT,"sign timeout",null)}}}},error:function(y,z,x){handleRestError(y,z,x)},cache:false})},j)};this.removeTransaction=function(){jQuery.post(s+"/"+g+"/"+o.tsRemove,function(w){console.log("remove transaction ok");g=undefined}).fail(function(x,y,w){g=undefined;console.log("remove transaction xhr: "+JSON.stringify(x));console.log("remove transaction status: "+x.status);console.log("remove transaction textStatus: "+y);console.log("remove transaction errorThrown: "+w)})};this.setOption=function(w,x){c[w]=x};this.addDocument=function(z,y,x,w){jQuery.when(p).done(function(){var A=jQuery.Deferred();addDocumentRest(A,z,y,x,w);b.push(A)})};this.setErrorCallback=function(w){f=w};this.sign=function(w){if(g===undefined){startTransaction(p)}else{p.resolve()}jQuery.when(p).done(function(){var x=jQuery.Deferred();setConfig(x);jQuery.when.apply(this,b).done(function(){jQuery.when(x).done(function(){openApplication();pollSignStatus(w)})})})};this.getToken=function(){return g}};